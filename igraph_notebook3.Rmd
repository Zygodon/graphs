---
title: "igraph notebook 3"
output: html_notebook
---
Following igraph_notebook2. I remain impressed by ideas about the development of traits and co-evolution, e.g.  (*https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2148393/; The modularity of pollination networks; Jens M. Olesen, Jordi Bascompte, Yoko L. Dupont, and Pedro Jordano, 2007*). It occurs to me that there might be cooperative interactions between meadow plants, e.g. sharing mycorrhiza; or short-roots cooperating with deep roots; biochemical exchanges in the soil. Would these show up as short-range interactions between plants? Here I've examined communities based on the pairwise odds-ratio of plants being found in the same quadrat. Would truly short-range interactions show up less strongly in community structures based on pairwise odds-ratio of plants being found in the same assembly (bigger area)?

Load libraries and functions:
```{r}
# Libraries
library("RMySQL")
library(tidyverse)
library(networkD3)
library(igraph)

# Functions
dbDisconnectAll <- function(){
  ile <- length(dbListConnections(MySQL())  )
  lapply( dbListConnections(MySQL()), function(x) dbDisconnect(x) )
  cat(sprintf("%s connection(s) closed.\n", ile))
}

# General SQL query
query <- function(q)
{
  # Remote DB with password
  con <- dbConnect(MySQL(), 
                   user  = "guest",
                   password    = "guest",
                   dbname="meadows",
                   port = 3306,
                   host   = "sxouse.ddns.net")
  rs1 = dbSendQuery(con, q)
  return(as_tibble(fetch(rs1, n=-1)))
  dbDisconnectAll()
}

# Load the database
GetTheData <-  function()
{
  # GET DATA FROM DB
  # Remote DB with password
  con <- dbConnect(MySQL(), 
                   user  = "guest",
                   password    = "guest",
                   dbname="meadows",
                   port = 3306,
                   host   = "sxouse.ddns.net")
  
  
  q <- sprintf('select assembly_id, assembly_name, quadrat_count, community, quadrat_id, quadrat_size, visit_date, records_id, species.species_id, 
    species.species_name from assemblies
      join quadrats on quadrats.assembly_id = assemblies_id
      join visit_dates on quadrats.vd_id = visit_dates.vds_id
      join records on records.quadrat_id = quadrats_id
      join species on species.species_id = records.species_id
      # Two assemblies have 0 quadrat count; exclude A.capillaris_stolonifera;
      # exclude some odd assemblies with no assigned community
    where quadrat_count > 0 and species.species_id != 4 and community is not null;') 
  # NOTE: this extract includes "MG5", i.e. some MG5 communities where 
  # the team have not decided
  # on a sub-group.
  
  rs1 = dbSendQuery(con, q)
  return(as_tibble(fetch(rs1, n=-1)))
  dbDisconnectAll()
}

OddsRatio <-  function(d, A, B) # quadrat_data, species_name, species_name
{
  A <- A[1]
  B <- B[1]
  t <- d %>% filter(species_name %in% c(A, B))
  As <- t %>% filter(species_name == A)
  Bs <- t %>% filter(species_name == B)
  j1 <- full_join(As, Bs, by = "quadrat_id")
  # get all the quadrats, including ones with neither A nor B
  q <- d %>% distinct(quadrat_id) 
  j2 <- (left_join(q, j1, by = "quadrat_id") 
         # NOTE: column length q >= column length j1
         %>% mutate(AandB = !is.na(species_name.x) & !is.na(species_name.y))
         %>% mutate(AnotB = !is.na(species_name.x) & is.na(species_name.y))
         %>% mutate(BnotA = !is.na(species_name.y) & is.na(species_name.x))
         %>% mutate(neither = is.na(species_name.x) & is.na(species_name.y)))
  s <- colSums(j2[,4:7])
  # Standard Error https://en.wikipedia.org/wiki/Odds_ratio
  se <- sqrt((1/s[1] + (1/s[2]) + (1/s[3]) + (1/s[4]))) # std error of the log(o_r)
  o_r <- (s[1]*s[4])/(s[2]*s[3])
  ci_low <- exp(log(o_r)-1.96*se)
  ci_high <- exp(log(o_r)+1.96*se)
  retval <- c(o_r, ci_low, ci_high)
  names(retval) <- c("odds_ratio", "ci_low", "ci_high")
  return(retval)
}

# End of functions
```

Load data, note excluding 4x4 quadrats so all this analysis is based on 2x2m quadrats. 
```{r}
the_data <- GetTheData()
quadrat_data <- (the_data %>% filter(quadrat_size == "2x2")
             %>% select(quadrat_id, species_name))

```
Making edges for the graph objects. The nodes (vertices) will be plant species, joined together by the fact of sharing a common quadrat. Note the group_by(from, to) followed by summarise(wt = n()). The weight (wt) is the number of quadrats that share this pait of plants.
```{r}
edges <- (full_join(quadrat_data, quadrat_data, by = "quadrat_id")
           %>% rename(from = species_name.x)
           %>% rename(to = species_name.y)
           %>%  select(-quadrat_id)
           %>% group_by(from, to) 
           %>% summarise(wt = n())
           %>% filter(from != to))
nodes <- distinct(edges, from)
```
The graph made from these edges and nodes (vertices) is huge and contains redundant edges arising from (a) plants always share a quadrat with themselves; and (b) if species A shares a quadrat with species B, then species B shares the quadrat with A. So there are twice as many edges as there need to be. I tried to find ways to eliminate the duplicate edges using my own code; in the end I found it easier to use igraph's simplify function.
```{r}
net <- graph_from_data_frame(d = edges, vertices = nodes, directed = F)
n2 <- simplify(net, edge.attr.comb = "ignore")
edges2 <- as_data_frame(n2, what="edges")
```
The next step is to find a way to quantify the strength of the associations between pairs of plants, and to simplify the graph by eliminating weak associations. The weight parameter is perhaps not the most appropriate; I use odds ratio, the ratio of the odds of A in the presence of B and the odds of A in the absence of B (Wikipedia)
```{r}
# It's much quicker to read the file than to compute from scratch
if (file.exists("Pairwise_Odds_Ratio.csv"))
{
  pairwise_o_r <- read.csv("Pairwise_Odds_Ratio.csv") 
} else
{
  n <- length(row.names(edges2))
  pairwise_o_r <- tibble(
    odds_ratio = 1:n,
    ci_low = 1:n,
    ci_high = 1:n)
  for (i in seq_along(row.names(edges2)))
  {
    pairwise_o_r[i,1:3] <- OddsRatio(quadrat_data, edges2$from[i], edges2$to[i])
  }
}
```
The OddsRatio function calculates approximate confidence intervals as well as the ratio itslef, so now we can simplify things by removing edges where the low (5%) confidence limit is greater than 1 (odds ratio of 1 signifies absolute independence; greater than one is some degree of association. Less than one signifies relative exclusion).
```{r}
edges3 <-( bind_cols(edges2, pairwise_o_r)
           %>% filter(!is.infinite(odds_ratio))
           %>% filter(!is.infinite(ci_low))
           %>% filter(!is.infinite(ci_high))
           %>% filter(!is.na(ci_low))
           %>% filter(!is.na(ci_high))
           %>% filter(ci_low > 1))
net2 <- graph_from_data_frame(d = edges3, vertices = nodes, directed = F)
l <- layout.fruchterman.reingold(net2)
plot(net2, layout=l, vertex.size = 2, vertex.label=NA)
```
This graph shows that removing low odds-ratio edges has isolated many species, we need to remove them too.
```{r}
# Remove isolated vertices (species)
isolated = which(degree(net2)==0)
net3 = delete.vertices(net2, isolated)
l2 = l[-isolated,]
plot(net3, layout=l2, vertex.size = 5,vertex.label=NA)
```
And now we are in a position to look for evidence of some kind of community structure:

```{r}
wc <- cluster_walktrap(net3)
modularity(wc)
plot(wc, net3, layout = l2, vertex.label=NA)
```
Cluster_walktrap finds 5 communities; 1 - 3 are large, 5 is a singleton (Linum_catharticum) and 4 consistes of Fissidens_taxifolius, Oenanthe_pimpinelloides, Plagiomnium_undulatum. Only a single assembly contained corky fruited water dropwort, community 4 is likely driven by that fact.

However. Leaving aside the beauty of modularity (which I'm sure I will return to), the purpose here was to investigate whether the pairwise odds_ratios (PWOR) could be used to get evidence for specific short range dependencies. So I will compare pairwise odds_ratios from shared quadrats with pairwise odds_ratios from whole assemblies. On the whole, we expect the assembly level PWOR to be greater than the quadrat level on account of the latger area sampled; there is more chance of two species sharing an assembly. This would not necessarily be the case, however, if (a) both members of a pair were very common - and particularly if they had large values for percentage cover - or (b) there was a specific close-range association between them (not excluded by case "a", of course). So pairs of relatively scarce plants for which PWOR is similar by quadrat and by assembly will be of interest.

Calculate assembly level PWOR.
